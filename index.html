<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Medium CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- React and Babel for in-browser JSX transformation -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        #root { height: 100vh; }
        /* Simple spinner for loading states */
        .spinner { border: 2px solid rgba(0, 0, 0, 0.1); width: 20px; height: 20px; border-radius: 50%; border-left-color: #06b6d4; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Main App Component ---
        function App() {
            const [squareAccessToken, setSquareAccessToken] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [loadingMessage, setLoadingMessage] = useState('');
            const [error, setError] = useState('');
            
            // Data stores
            const [allCustomers, setAllCustomers] = useState([]);
            const [customers, setCustomers] = useState([]); // This will be the filtered list
            const [groupsMap, setGroupsMap] = useState(new Map());
            const [segmentsMap, setSegmentsMap] = useState(new Map());
            const [locationId, setLocationId] = useState(null);
            
            // View management
            const [currentView, setCurrentView] = useState('dashboard'); // 'dashboard', 'profile', 'reports'
            const [selectedCustomer, setSelectedCustomer] = useState(null);
            const [customerDetails, setCustomerDetails] = useState(null);


            const API_PROXY_URL = 'https://square-checkin-backend.onrender.com';

            const apiFetch = async (endpoint, options = {}) => {
                const response = await fetch(`${API_PROXY_URL}/api${endpoint}`, {
                    ...options,
                    headers: {
                        ...options.headers,
                        'x-square-access-token': squareAccessToken,
                        'Content-Type': 'application/json',
                    },
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.errors?.[0]?.detail || data.error || 'An API error occurred.');
                }
                return data;
            };

            // Effect to fetch initial data once the token is set
            useEffect(() => {
                if (squareAccessToken) {
                    const fetchInitialData = async () => {
                        setIsLoading(true);
                        setLoadingMessage('Fetching initial data...');
                        setError('');
                        
                        try {
                            const [_, groupsData, segmentsData, locationData] = await Promise.all([
                                fetchAllCustomers(),
                                apiFetch('/v2/customers/groups'),
                                apiFetch('/v2/customers/segments'),
                                apiFetch('/v2/locations')
                            ]);

                            if (groupsData.groups) setGroupsMap(new Map(groupsData.groups.map(g => [g.id, g.name])));
                            if (segmentsData.segments) setSegmentsMap(new Map(segmentsData.segments.map(s => [s.id, s.name])));
                            
                            const activeLocation = locationData.locations?.find(loc => loc.status === 'ACTIVE');
                            if (activeLocation) setLocationId(activeLocation.id);
                            else throw new Error("No active location found for this business.");

                        } catch (err) {
                            setError(err.message);
                        } finally {
                            setIsLoading(false);
                            setLoadingMessage('');
                        }
                    };
                    
                    const fetchAllCustomers = async () => {
                        setLoadingMessage('Fetching all customers...');
                        let fetchedCustomers = [];
                        let cursor = undefined;
                        do {
                            const data = await apiFetch('/v2/customers/search', {
                                method: 'POST',
                                body: JSON.stringify({
                                    query: { sort: { field: "CREATED_AT", order: "DESC" } },
                                    cursor: cursor
                                })
                            });
                            if (data.customers) fetchedCustomers = [...fetchedCustomers, ...data.customers];
                            cursor = data.cursor;
                        } while (cursor);
                        fetchedCustomers.sort((a, b) => (a.given_name || '').localeCompare(b.given_name || ''));
                        setAllCustomers(fetchedCustomers);
                        setCustomers(fetchedCustomers);
                    };

                    fetchInitialData();
                }
            }, [squareAccessToken]);

            const handleSearch = (searchTerm) => {
                setSelectedCustomer(null);
                setCustomerDetails(null);
                setCurrentView('dashboard');
                if (!searchTerm) {
                    setCustomers(allCustomers);
                    return;
                }
                
                const lowercasedTerm = searchTerm.toLowerCase();
                const filtered = allCustomers.filter(c => 
                    (c.given_name && c.given_name.toLowerCase().includes(lowercasedTerm)) ||
                    (c.family_name && c.family_name.toLowerCase().includes(lowercasedTerm)) ||
                    (c.email_address && c.email_address.toLowerCase().includes(lowercasedTerm)) ||
                    (c.phone_number && c.phone_number.includes(searchTerm))
                );
                setCustomers(filtered);
            };
            
            const handleSelectCustomer = (customer) => {
                setIsLoading(true);
                setSelectedCustomer(customer);
                setCustomerDetails(null);
                setCurrentView('profile');
                setLoadingMessage('Fetching details...');
                setError('');

                const fetchDetails = async () => {
                    if (!locationId) {
                        setError("Location ID is not set. Cannot fetch orders.");
                        setIsLoading(false);
                        return;
                    }

                    try {
                        const [customerData, ordersData] = await Promise.all([
                            apiFetch(`/v2/customers/${customer.id}`),
                            apiFetch('/v2/orders/search', {
                                method: 'POST',
                                body: JSON.stringify({
                                    location_ids: [locationId],
                                    query: {
                                        filter: {
                                            customer_filter: { customer_ids: [customer.id] },
                                            state_filter: { states: ["COMPLETED"] }
                                        },
                                        sort: { sort_field: "CLOSED_AT", sort_order: "DESC" }
                                    },
                                    limit: 1
                                })
                            })
                        ]);
                        
                        setCustomerDetails({ ...customerData.customer, last_visit: ordersData.orders?.[0]?.closed_at });

                    } catch (err) {
                        setError(err.message);
                    } finally {
                        setIsLoading(false);
                        setLoadingMessage('');
                    }
                };
                
                fetchDetails();
            };

            const renderMainContent = () => {
                if (isLoading) return <div className="flex justify-center items-center h-full"><div className="spinner"></div><p className="ml-2">{loadingMessage}</p></div>;
                if (error) return <div className="text-red-500 text-center">{error}</div>;

                switch(currentView) {
                    case 'profile':
                        return customerDetails ? <CustomerProfile customer={customerDetails} groupsMap={groupsMap} segmentsMap={segmentsMap} /> : null;
                    case 'reports':
                        return <ReportsPage apiFetch={apiFetch} locationId={locationId} onSelectCustomer={handleSelectCustomer} onBack={() => setCurrentView('dashboard')} />;
                    case 'dashboard':
                    default:
                        return <Dashboard onNavigate={setCurrentView} />;
                }
            };

            if (!squareAccessToken) {
                return <AdminSetup onSave={setSquareAccessToken} />;
            }

            return (
                <div className="flex h-full bg-gray-100">
                    {/* Sidebar */}
                    <div className="w-1/3 max-w-sm bg-white border-r border-gray-200 flex flex-col">
                        <div className="p-4 border-b">
                            <h1 className="text-xl font-bold text-gray-800">Customer Search</h1>
                        </div>
                        <SearchBar onSearch={handleSearch} />
                        {isLoading && allCustomers.length === 0 ? (
                            <div className="p-4 text-center text-gray-500 flex flex-col items-center justify-center h-full">
                                <div className="spinner"></div>
                                <p className="mt-2">{loadingMessage}</p>
                            </div>
                        ) : (
                            <CustomerList customers={customers} onSelectCustomer={handleSelectCustomer} selectedCustomerId={selectedCustomer?.id} />
                        )}
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 p-8 overflow-y-auto">
                        {renderMainContent()}
                    </div>
                </div>
            );
        }

        // --- Child Components ---

        function AdminSetup({ onSave }) {
            const [token, setToken] = useState('');
            return (
                <div className="flex items-center justify-center h-full">
                    <div className="w-full max-w-md p-8 bg-white rounded-lg shadow-md text-center">
                        <h1 className="text-2xl font-bold text-gray-800">CRM Setup</h1>
                        <p className="text-gray-500 mt-2 mb-6">Please enter your Square Access Token to begin.</p>
                        <div className="flex items-center space-x-3">
                            <input type="password" value={token} onChange={(e) => setToken(e.target.value)} className="flex-grow block w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md" placeholder="Square Access Token" />
                            <button onClick={() => onSave(token)} className="px-6 py-2 text-white bg-cyan-600 rounded-md hover:bg-cyan-700">Save</button>
                        </div>
                    </div>
                </div>
            );
        }

        function SearchBar({ onSearch }) {
            const [term, setTerm] = useState('');
            const handleChange = (e) => { setTerm(e.target.value); onSearch(e.target.value); };
            return (
                <div className="p-4 border-b">
                    <input type="text" value={term} onChange={handleChange} placeholder="Filter by name, email, or phone..." className="w-full px-4 py-2 border rounded-md" />
                </div>
            );
        }

        function CustomerList({ customers, onSelectCustomer, selectedCustomerId }) {
            if (customers.length === 0) {
                return <div className="p-4 text-center text-gray-500">No customers match your search.</div>;
            }
            return (
                <ul className="overflow-y-auto">
                    {customers.map(customer => (
                        <li key={customer.id}>
                            <button onClick={() => onSelectCustomer(customer)} className={`w-full text-left p-4 hover:bg-cyan-50 ${selectedCustomerId === customer.id ? 'bg-cyan-100' : ''}`}>
                                <p className="font-semibold text-gray-800">{customer.given_name} {customer.family_name}</p>
                                <p className="text-sm text-gray-500">{customer.email_address || 'No email'}</p>
                            </button>
                        </li>
                    ))}
                </ul>
            );
        }

        function Dashboard({ onNavigate }) {
            return (
                <div>
                    <h2 className="text-4xl font-bold text-gray-800">Dashboard</h2>
                    <p className="text-gray-500">Welcome to your Social Medium CRM.</p>
                    <div className="mt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <button onClick={() => onNavigate('reports')} className="p-6 bg-white rounded-lg shadow hover:bg-cyan-50 text-left transition">
                            <h3 className="text-xl font-semibold text-gray-800">Reports</h3>
                            <p className="text-gray-500 mt-2">Filter customers by purchase history and activity.</p>
                        </button>
                    </div>
                </div>
            );
        }
        
        function ReportsPage({ apiFetch, locationId, onSelectCustomer, onBack }) {
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');
            const [itemName, setItemName] = useState('');
            const [results, setResults] = useState([]);

            const handleRunReport = async (e) => {
                e.preventDefault();
                if (!itemName) return;
                setIsLoading(true);
                setError('');
                setResults([]);
                try {
                    // 1. Find the item ID from its name
                    const itemSearchData = await apiFetch('/v2/catalog/search', {
                        method: 'POST',
                        body: JSON.stringify({ object_types: ["ITEM"], query: { text_query: { keywords: [itemName] } } })
                    });
                    const item = itemSearchData.objects?.find(obj => obj.item_data.name.toLowerCase() === itemName.toLowerCase());
                    if (!item) throw new Error(`Item "${itemName}" not found in catalog.`);
                    const variationIds = item.item_data.variations.map(v => v.id);

                    // 2. Search for orders containing that item
                    const orderSearchData = await apiFetch('/v2/orders/search', {
                        method: 'POST',
                        body: JSON.stringify({
                            location_ids: [locationId],
                            query: {
                                filter: {
                                    state_filter: { states: ["COMPLETED"] },
                                    line_item_filter: { catalog_object_ids: variationIds }
                                }
                            }
                        })
                    });
                    
                    const customerIds = [...new Set(orderSearchData.orders?.map(o => o.customer_id).filter(Boolean))];
                    if (customerIds.length === 0) {
                        setResults([]);
                        return;
                    }

                    // 3. Fetch details for the found customers, handling the 100-limit.
                    const chunkSize = 100;
                    const customerIdChunks = [];
                    for (let i = 0; i < customerIds.length; i += chunkSize) {
                        customerIdChunks.push(customerIds.slice(i, i + chunkSize));
                    }

                    const promises = customerIdChunks.map(chunk =>
                        apiFetch('/v2/customers/bulk-retrieve', {
                            method: 'POST',
                            body: JSON.stringify({ customer_ids: chunk })
                        })
                    );

                    const resultsData = await Promise.all(promises);
                    const allCustomersFromReport = resultsData.flatMap(result => result.customers || []);
                    setResults(allCustomersFromReport);

                } catch (err) {
                    setError(err.message);
                } finally {
                    setIsLoading(false);
                }
            };
            
            return (
                <div>
                    <button onClick={onBack} className="mb-6 text-cyan-600 hover:text-cyan-800"> &larr; Back to Dashboard</button>
                    <h2 className="text-4xl font-bold text-gray-800">Reports</h2>
                    <p className="text-gray-500">Find customers based on what they've purchased.</p>

                    <form onSubmit={handleRunReport} className="mt-8 p-6 bg-white rounded-lg shadow">
                        <label className="block text-sm font-medium text-gray-700">Item Name</label>
                        <div className="mt-1 flex space-x-3">
                            <input type="text" value={itemName} onChange={e => setItemName(e.target.value)} className="flex-grow block w-full px-4 py-2 border rounded-md" placeholder="e.g., Day Pass" />
                            <button type="submit" className="px-6 py-2 text-white bg-cyan-600 rounded-md hover:bg-cyan-700" disabled={isLoading}>
                                {isLoading ? <div className="spinner"></div> : 'Run Report'}
                            </button>
                        </div>
                    </form>
                    
                    {error && <div className="mt-4 text-red-500">{error}</div>}

                    <div className="mt-8">
                        <h3 className="text-2xl font-bold text-gray-800">Results ({results.length})</h3>
                        <div className="mt-4 bg-white rounded-lg shadow overflow-hidden">
                            <ul className="divide-y divide-gray-200">
                                {results.map(customer => (
                                    <li key={customer.id}>
                                        <button onClick={() => onSelectCustomer(customer)} className="w-full text-left p-4 hover:bg-gray-50">
                                            <p className="font-semibold text-gray-800">{customer.given_name} {customer.family_name}</p>
                                            <p className="text-sm text-gray-500">{customer.email_address}</p>
                                        </button>
                                    </li>
                                ))}
                            </ul>
                        </div>
                    </div>
                </div>
            );
        }

        function CustomerProfile({ customer, groupsMap, segmentsMap }) {
            const formatDate = (dateString) => {
                if (!dateString) return 'N/A';
                return new Date(dateString).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric' });
            };
            const formatAddress = (address) => {
                if (!address) return 'N/A';
                const parts = [ address.address_line_1, address.address_line_2, `${address.locality || ''} ${address.administrative_district_level_1 || ''} ${address.postal_code || ''}`.trim(), address.country ];
                return parts.filter(Boolean).join(', ');
            };
            return (
                <div>
                    <h2 className="text-4xl font-bold text-gray-800">{customer.given_name} {customer.family_name}</h2>
                    <p className="text-gray-500">Customer since {formatDate(customer.created_at)}</p>
                    <div className="mt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <InfoCard title="Contact Information"><InfoItem label="Email" value={customer.email_address} /><InfoItem label="Phone" value={customer.phone_number} /></InfoCard>
                        <InfoCard title="Address"><p className="text-gray-800">{formatAddress(customer.address)}</p></InfoCard>
                        <InfoCard title="Stats"><InfoItem label="Last Visit" value={customer.last_visit ? formatDate(customer.last_visit) : 'No visits found'} /><InfoItem label="Source" value={customer.creation_source} /></InfoCard>
                        <InfoCard title="Details" className="md:col-span-2 lg:col-span-1"><InfoItem label="Birthday" value={customer.birthday} /><InfoItem label="Company" value={customer.company_name} /><InfoItem label="Reference ID" value={customer.reference_id} /></InfoCard>
                        <InfoCard title="Groups & Segments" className="md:col-span-3"><div className="flex flex-wrap gap-2">{(customer.group_ids || []).map(id => <Pill key={id} text={groupsMap.get(id) || id} />)}{(customer.segment_ids || []).map(id => <Pill key={id} text={segmentsMap.get(id) || id} color="bg-green-100 text-green-800" />)}</div></InfoCard>
                        <InfoCard title="Notes" className="md:col-span-3"><p className="text-gray-700 whitespace-pre-wrap">{customer.note || 'No notes for this customer.'}</p></InfoCard>
                    </div>
                </div>
            );
        }
        
        const InfoCard = ({ title, children, className }) => (<div className={`bg-white p-6 rounded-lg shadow ${className || ''}`}><h3 className="text-lg font-semibold text-gray-800 border-b pb-2 mb-4">{title}</h3><div className="space-y-3">{children}</div></div>);
        const InfoItem = ({ label, value }) => (<div><p className="text-sm text-gray-500">{label}</p><p className="font-medium text-gray-800">{value || 'N/A'}</p></div>);
        const Pill = ({ text, color = 'bg-gray-100 text-gray-800' }) => (<span className={`px-3 py-1 text-sm font-medium rounded-full ${color}`}>{text}</span>);

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
